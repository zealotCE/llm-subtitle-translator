"use client";

import { createContext, useContext, useEffect, useMemo, useState } from "react";

type Locale = "zh" | "en";

const FALLBACK_LOCALE: Locale = "zh";
const STORAGE_KEY = "ui_lang";

const translations: Record<Locale, Record<string, string>> = {
  zh: {
    "nav.dashboard": "总览",
    "nav.library": "媒体库",
    "nav.import": "导入",
    "nav.activity": "活动",
    "nav.settings": "设置",
    "nav.advanced": "高级",
    "nav.language": "语言",
    "common.loading": "加载中…",
    "common.search": "搜索",
    "common.save": "保存",
    "common.saved": "已保存",
    "common.saveFailed": "保存失败",
    "common.loadFailed": "加载失败",
    "common.actionFailed": "操作失败",
    "toast.actionTriggered": "已触发操作",
    "toast.scanTriggered": "已触发扫描",
    "common.failed": "失败",
    "common.success": "成功",
    "common.cancel": "取消",
    "common.retry": "重试",
    "common.refresh": "刷新",
    "common.close": "关闭",
    "common.translate": "翻译",
    "common.archive": "归档",
    "common.unarchive": "取消归档",
    "common.download": "下载",
    "common.edit": "编辑",
    "common.preview": "预览",
    "common.export": "导出",
    "common.next": "下一页",
    "common.prev": "上一页",
    "common.page": "第",
    "common.of": "共",
    "dashboard.title": "总览",
    "dashboard.subtitle": "关注媒体处理进度与失败项。",
    "dashboard.openLibrary": "打开媒体库",
    "dashboard.viewActivity": "查看活动",
    "dashboard.total": "总媒体数",
    "dashboard.totalDesc": "已发现媒体总量",
    "dashboard.active": "处理中",
    "dashboard.activeDesc": "pending / running",
    "dashboard.missingZh": "缺简中",
    "dashboard.missingZhDesc": "需要翻译的条目",
    "dashboard.recentFailed": "最近失败",
    "dashboard.recentFailedDesc": "需要关注的媒体",
    "dashboard.recentDone": "最近完成",
    "dashboard.recentDoneDesc": "最新完成的字幕",
    "library.title": "媒体库",
    "library.searchPlaceholder": "搜索文件名或标题",
    "library.filter.missingZh": "缺简中",
    "library.filter.failed": "失败",
    "library.filter.running": "处理中",
    "library.filter.archived": "已归档",
    "library.sort.updated": "最近更新",
    "library.sort.created": "最近创建",
    "library.sort.failed": "失败优先",
    "library.pageSize": "每页",
    "library.rescan": "重新扫描",
    "library.import": "导入媒体",
    "library.count": "总数",
    "library.filtered": "当前",
    "library.missing": "缺简中",
    "library.exportJson": "导出 JSON",
    "library.exportCsv": "导出 CSV",
    "library.exportMissingJson": "导出缺简中 JSON",
    "library.exportMissingCsv": "导出缺简中 CSV",
    "library.filterTitle": "筛选",
    "library.actionsTitle": "操作",
    "library.table.title": "标题",
    "library.table.status": "状态",
    "library.table.subtitles": "字幕",
    "library.table.actions": "操作",
    "library.empty": "暂无媒体",
    "activity.title": "活动",
    "activity.type": "类型",
    "activity.status": "状态",
    "activity.filterAll": "全部",
    "activity.type.media_added": "新增媒体",
    "activity.type.status_change": "状态变化",
    "activity.type.retry": "重试",
    "activity.type.translate": "翻译",
    "activity.msg.media_added": "发现新媒体",
    "activity.msg.status_change": "状态更新",
    "activity.msg.retry": "触发重试",
    "activity.msg.translate": "触发翻译",
    "activity.systemLogs": "系统日志",
    "logs.title": "系统日志",
    "logs.keyword": "关键词",
    "logs.limit": "条数",
    "logs.exportJson": "导出 JSON",
    "logs.exportCsv": "导出 CSV",
    "logs.empty": "暂无日志",
    "activity.mediaLink": "查看媒体",
    "activity.runLink": "查看运行",
    "activity.empty": "暂无活动记录",
    "settings.title": "设置",
    "settings.group.watch": "扫描与监听",
    "settings.group.asr": "语音识别",
    "settings.group.translation": "翻译",
    "settings.group.oss": "OSS",
    "settings.group.web": "Web/Auth",
    "settings.group.metadata": "外部元数据",
    "settings.label.watchDirs": "监听目录",
    "settings.label.watchRecursive": "递归扫描",
    "settings.label.scanInterval": "扫描间隔（秒）",
    "settings.label.outputToSource": "输出到源目录",
    "settings.label.deleteSourceAfterDone": "完成后删除源视频",
    "settings.label.asrMode": "ASR 模式",
    "settings.label.asrModel": "ASR 模型",
    "settings.label.languageHints": "语言提示",
    "settings.label.llmModel": "翻译模型",
    "settings.label.llmBaseUrl": "LLM Base URL",
    "settings.label.llmApiKey": "LLM API Key",
    "settings.label.batchLines": "批量行数",
    "settings.label.concurrency": "并发数",
    "settings.label.ossEndpoint": "OSS Endpoint",
    "settings.label.ossBucket": "OSS Bucket",
    "settings.label.ossAccessKeyId": "OSS Access Key ID",
    "settings.label.ossAccessKeySecret": "OSS Access Key Secret",
    "settings.label.ossUrlMode": "URL 模式",
    "settings.label.webAuthEnabled": "启用登录",
    "settings.label.webAuthUser": "登录用户",
    "settings.label.webAuthPassword": "登录密码",
    "settings.label.tmdbApiKey": "TMDB API Key",
    "settings.label.bangumiToken": "Bangumi Access Token",
    "settings.option.on": "开启",
    "settings.option.off": "关闭",
    "settings.option.custom": "自定义",
    "settings.advanced": "高级",
    "settings.advancedOpen": "展开 .env 编辑器",
    "settings.advancedClose": "收起 .env 编辑器",
    "settings.loadEnv": "加载完整 .env",
    "settings.exportJson": "导出配置 JSON",
    "settings.loading": "正在加载配置…",
    "settings.loadFailed": "加载配置失败",
    "settings.save": "保存配置",
    "settings.saving": "保存中…",
    "settings.saved": "已保存配置",
    "settings.saveFailed": "保存失败",
    "settings.hidden": "已隐藏，留空不修改",
    "import.title": "导入",
    "import.subtitle": "提交媒体或上传文件。",
    "import.pathLabel": "媒体路径",
    "import.pathPlaceholder": "输入视频文件路径",
    "import.submit": "提交导入",
    "import.upload": "上传文件",
    "import.done": "已提交",
    "import.failed": "导入失败",
    "import.loading": "导入中…",
    "import.fileLabel": "媒体文件",
    "import.fileRequired": "请选择文件",
    "import.asrMode": "ASR 模式",
    "import.segmentMode": "切片模式",
    "import.dragHint": "拖拽文件到此处，或点击按钮选择",
    "import.sizeHint": "大文件上传耗时较长，建议使用局域网。",
    "import.viewMedia": "查看媒体详情",
    "import.viewLibrary": "返回媒体库",
    "media.subtitles": "字幕",
    "media.runs": "运行记录",
    "media.metadata": "元数据",
    "media.files": "文件",
    "media.subtitles.empty": "暂无字幕输出",
    "media.subtitles.previewHint": "点击“预览”查看字幕内容",
    "media.runs.empty": "暂无运行记录",
    "media.metadata.desc": "通过表单补全作品信息。",
    "media.metadata.save": "保存元数据",
    "media.metadata.advancedOpen": "展开高级 JSON",
    "media.metadata.advancedClose": "收起高级 JSON",
    "media.metadata.saveAdvanced": "保存高级 JSON",
    "media.metadata.jsonError": "JSON 格式错误",
    "media.metadata.glossaryError": "术语表 JSON 格式错误",
    "media.metadata.charactersError": "角色列表 JSON 格式错误",
    "media.metadata.saved": "已保存",
    "media.meta.titleOriginal": "原始标题",
    "media.meta.titleZh": "简体标题",
    "media.meta.titleEn": "英文标题",
    "media.meta.languageHints": "语言提示",
    "media.meta.type": "类型",
    "media.meta.year": "年份",
    "media.meta.season": "季",
    "media.meta.episode": "集",
    "media.meta.episodeTitleJa": "本集标题（日）",
    "media.meta.episodeTitleZh": "本集标题（简中）",
    "media.meta.episodeTitleEn": "本集标题（英文）",
    "media.meta.tmdbId": "TMDb ID",
    "media.meta.bangumiId": "Bangumi ID",
    "media.meta.wmdbId": "WMDB ID",
    "media.meta.imdbId": "IMDb ID",
    "media.meta.glossary": "术语表（JSON）",
    "media.meta.characters": "角色列表（JSON）",
    "media.meta.notes": "备注",
    "media.subtitle.kind.raw": "原文",
    "media.subtitle.kind.zh": "简中",
    "media.subtitle.kind.bi": "双语",
    "media.subtitle.kind.other": "附加字幕",
    "run.title": "运行详情",
    "run.log": "运行日志",
    "run.noLog": "暂无日志",
    "run.field.id": "ID",
    "run.field.media": "媒体",
    "run.field.type": "类型",
    "run.field.status": "状态",
    "run.field.started": "开始时间",
    "run.field.finished": "结束时间",
    "run.field.duration": "耗时",
    "editor.title": "字幕编辑",
    "editor.search": "搜索字幕",
    "editor.save": "保存字幕",
    "editor.saveAs": "另存版本",
    "editor.saved": "已保存字幕",
    "editor.selectHint": "选择字幕条目",
    "editor.empty": "暂无字幕内容",
    "status.pending": "待处理",
    "status.running": "处理中",
    "status.failed": "失败",
    "status.done": "完成",
    "status.archived": "已归档",
    "status.info": "信息",
    "admin.notice": "高级功能会暴露工程配置与底层路径。普通用户请使用设置页。",
    "admin.openSettings": "打开设置（含高级）",
    "login.title": "登录",
    "login.subtitle": "账号验证",
    "login.username": "用户名",
    "login.password": "密码",
    "login.submit": "登录",
    "login.failed": "登录失败",
  },
  en: {
    "nav.dashboard": "Dashboard",
    "nav.library": "Library",
    "nav.import": "Import",
    "nav.activity": "Activity",
    "nav.settings": "Settings",
    "nav.advanced": "Advanced",
    "nav.language": "Language",
    "common.loading": "Loading…",
    "common.search": "Search",
    "common.save": "Save",
    "common.saved": "Saved",
    "common.saveFailed": "Save failed",
    "common.loadFailed": "Load failed",
    "common.actionFailed": "Action failed",
    "toast.actionTriggered": "Action triggered",
    "toast.scanTriggered": "Scan triggered",
    "common.failed": "Failed",
    "common.success": "Success",
    "common.cancel": "Cancel",
    "common.retry": "Retry",
    "common.refresh": "Refresh",
    "common.close": "Close",
    "common.translate": "Translate",
    "common.archive": "Archive",
    "common.unarchive": "Unarchive",
    "common.download": "Download",
    "common.edit": "Edit",
    "common.preview": "Preview",
    "common.export": "Export",
    "common.next": "Next",
    "common.prev": "Prev",
    "common.page": "Page",
    "common.of": "of",
    "dashboard.title": "Dashboard",
    "dashboard.subtitle": "Monitor media progress and failures.",
    "dashboard.openLibrary": "Open Library",
    "dashboard.viewActivity": "View Activity",
    "dashboard.total": "Total Media",
    "dashboard.totalDesc": "All discovered media",
    "dashboard.active": "Active",
    "dashboard.activeDesc": "pending / running",
    "dashboard.missingZh": "Missing zh",
    "dashboard.missingZhDesc": "Items to translate",
    "dashboard.recentFailed": "Recent Failed",
    "dashboard.recentFailedDesc": "Items to fix",
    "dashboard.recentDone": "Recent Done",
    "dashboard.recentDoneDesc": "Latest completed subtitles",
    "library.title": "Library",
    "library.searchPlaceholder": "Search by filename or title",
    "library.filter.missingZh": "Missing zh",
    "library.filter.failed": "Failed",
    "library.filter.running": "Running",
    "library.filter.archived": "Archived",
    "library.sort.updated": "Recently Updated",
    "library.sort.created": "Recently Created",
    "library.sort.failed": "Failed First",
    "library.pageSize": "Per page",
    "library.rescan": "Rescan",
    "library.import": "Import Media",
    "library.count": "Total",
    "library.filtered": "Showing",
    "library.missing": "Missing zh",
    "library.exportJson": "Export JSON",
    "library.exportCsv": "Export CSV",
    "library.exportMissingJson": "Export Missing JSON",
    "library.exportMissingCsv": "Export Missing CSV",
    "library.filterTitle": "Filters",
    "library.actionsTitle": "Actions",
    "library.table.title": "Title",
    "library.table.status": "Status",
    "library.table.subtitles": "Subtitles",
    "library.table.actions": "Actions",
    "library.empty": "No media found",
    "activity.title": "Activity",
    "activity.type": "Type",
    "activity.status": "Status",
    "activity.filterAll": "All",
    "activity.type.media_added": "Media Added",
    "activity.type.status_change": "Status Change",
    "activity.type.retry": "Retry",
    "activity.type.translate": "Translate",
    "activity.msg.media_added": "Media discovered",
    "activity.msg.status_change": "Status updated",
    "activity.msg.retry": "Retry triggered",
    "activity.msg.translate": "Translate triggered",
    "activity.systemLogs": "System Logs",
    "logs.title": "System Logs",
    "logs.keyword": "Keyword",
    "logs.limit": "Limit",
    "logs.exportJson": "Export JSON",
    "logs.exportCsv": "Export CSV",
    "logs.empty": "No logs yet",
    "activity.mediaLink": "Open Media",
    "activity.runLink": "Open Run",
    "activity.empty": "No activity yet",
    "settings.title": "Settings",
    "settings.group.watch": "Watch & Scan",
    "settings.group.asr": "ASR",
    "settings.group.translation": "Translation",
    "settings.group.oss": "OSS",
    "settings.group.web": "Web/Auth",
    "settings.group.metadata": "External Metadata",
    "settings.label.watchDirs": "Watch Dirs",
    "settings.label.watchRecursive": "Recursive Scan",
    "settings.label.scanInterval": "Scan Interval (s)",
    "settings.label.outputToSource": "Output To Source",
    "settings.label.deleteSourceAfterDone": "Delete Source After Done",
    "settings.label.asrMode": "ASR Mode",
    "settings.label.asrModel": "ASR Model",
    "settings.label.languageHints": "Language Hints",
    "settings.label.llmModel": "LLM Model",
    "settings.label.llmBaseUrl": "LLM Base URL",
    "settings.label.llmApiKey": "LLM API Key",
    "settings.label.batchLines": "Batch Lines",
    "settings.label.concurrency": "Concurrency",
    "settings.label.ossEndpoint": "OSS Endpoint",
    "settings.label.ossBucket": "OSS Bucket",
    "settings.label.ossAccessKeyId": "OSS Access Key ID",
    "settings.label.ossAccessKeySecret": "OSS Access Key Secret",
    "settings.label.ossUrlMode": "URL Mode",
    "settings.label.webAuthEnabled": "Enable Auth",
    "settings.label.webAuthUser": "Auth User",
    "settings.label.webAuthPassword": "Auth Password",
    "settings.label.tmdbApiKey": "TMDB API Key",
    "settings.label.bangumiToken": "Bangumi Access Token",
    "settings.option.on": "On",
    "settings.option.off": "Off",
    "settings.option.custom": "Custom",
    "settings.advanced": "Advanced",
    "settings.advancedOpen": "Open .env Editor",
    "settings.advancedClose": "Close .env Editor",
    "settings.loadEnv": "Load Full .env",
    "settings.exportJson": "Export Config JSON",
    "settings.loading": "Loading settings…",
    "settings.loadFailed": "Failed to load settings",
    "settings.save": "Save Settings",
    "settings.saving": "Saving…",
    "settings.saved": "Settings saved",
    "settings.saveFailed": "Save failed",
    "settings.hidden": "Hidden, leave blank to keep",
    "import.title": "Import",
    "import.subtitle": "Submit media or upload files.",
    "import.pathLabel": "Media Path",
    "import.pathPlaceholder": "Enter a video file path",
    "import.submit": "Submit",
    "import.upload": "Upload",
    "import.done": "Submitted",
    "import.failed": "Import failed",
    "import.loading": "Importing…",
    "import.fileLabel": "Media File",
    "import.fileRequired": "Please select a file",
    "import.asrMode": "ASR Mode",
    "import.segmentMode": "Segment Mode",
    "import.dragHint": "Drag a file here or click to choose",
    "import.sizeHint": "Large uploads may take time on the network.",
    "import.viewMedia": "Open Media Detail",
    "import.viewLibrary": "Back to Library",
    "media.subtitles": "Subtitles",
    "media.runs": "Runs",
    "media.metadata": "Metadata",
    "media.files": "Files",
    "media.subtitles.empty": "No subtitles",
    "media.subtitles.previewHint": "Click Preview to view content",
    "media.runs.empty": "No runs yet",
    "media.metadata.desc": "Edit manual metadata for this media.",
    "media.metadata.save": "Save Metadata",
    "media.metadata.advancedOpen": "Show Advanced JSON",
    "media.metadata.advancedClose": "Hide Advanced JSON",
    "media.metadata.saveAdvanced": "Save Advanced JSON",
    "media.metadata.jsonError": "Invalid JSON",
    "media.metadata.glossaryError": "Glossary JSON error",
    "media.metadata.charactersError": "Characters JSON error",
    "media.metadata.saved": "Saved",
    "media.meta.titleOriginal": "Original Title",
    "media.meta.titleZh": "Chinese Title",
    "media.meta.titleEn": "English Title",
    "media.meta.languageHints": "Language Hints",
    "media.meta.type": "Type",
    "media.meta.year": "Year",
    "media.meta.season": "Season",
    "media.meta.episode": "Episode",
    "media.meta.episodeTitleJa": "Episode Title (JA)",
    "media.meta.episodeTitleZh": "Episode Title (ZH)",
    "media.meta.episodeTitleEn": "Episode Title (EN)",
    "media.meta.tmdbId": "TMDb ID",
    "media.meta.bangumiId": "Bangumi ID",
    "media.meta.wmdbId": "WMDB ID",
    "media.meta.imdbId": "IMDb ID",
    "media.meta.glossary": "Glossary (JSON)",
    "media.meta.characters": "Characters (JSON)",
    "media.meta.notes": "Notes",
    "media.subtitle.kind.raw": "Raw",
    "media.subtitle.kind.zh": "Simplified",
    "media.subtitle.kind.bi": "Bilingual",
    "media.subtitle.kind.other": "Additional",
    "run.title": "Run Detail",
    "run.log": "Run Log",
    "run.noLog": "No logs yet",
    "run.field.id": "ID",
    "run.field.media": "Media",
    "run.field.type": "Type",
    "run.field.status": "Status",
    "run.field.started": "Started",
    "run.field.finished": "Finished",
    "run.field.duration": "Duration",
    "editor.title": "Subtitle Editor",
    "editor.search": "Search subtitles",
    "editor.save": "Save Subtitle",
    "editor.saveAs": "Save As",
    "editor.saved": "Subtitle saved",
    "editor.selectHint": "Select a subtitle block",
    "editor.empty": "No subtitles found",
    "status.pending": "Pending",
    "status.running": "Running",
    "status.failed": "Failed",
    "status.done": "Done",
    "status.archived": "Archived",
    "status.info": "Info",
    "admin.notice": "Advanced tools expose config and filesystem paths. Use Settings for normal use.",
    "admin.openSettings": "Open Settings (Advanced)",
    "login.title": "Login",
    "login.subtitle": "Account Verification",
    "login.username": "Username",
    "login.password": "Password",
    "login.submit": "Sign In",
    "login.failed": "Login failed",
  },
};

type I18nContextValue = {
  locale: Locale;
  setLocale: (next: Locale) => void;
  t: (key: string) => string;
};

const I18nContext = createContext<I18nContextValue>({
  locale: FALLBACK_LOCALE,
  setLocale: () => {},
  t: (key) => translations[FALLBACK_LOCALE][key] || key,
});

export function LocaleProvider({ children }: { children: React.ReactNode }) {
  const [locale, setLocale] = useState<Locale>(FALLBACK_LOCALE);

  useEffect(() => {
    const stored = window.localStorage.getItem(STORAGE_KEY);
    if (stored === "zh" || stored === "en") {
      setLocale(stored);
      return;
    }
    const envLang = (process.env.NEXT_PUBLIC_UI_LANG || "").trim().toLowerCase();
    if (envLang === "zh" || envLang === "en") {
      setLocale(envLang as Locale);
    }
  }, []);

  const handleSetLocale = (next: Locale) => {
    setLocale(next);
    window.localStorage.setItem(STORAGE_KEY, next);
  };

  const value = useMemo(
    () => ({
      locale,
      setLocale: handleSetLocale,
      t: (key: string) => translations[locale][key] || translations[FALLBACK_LOCALE][key] || key,
    }),
    [locale]
  );

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  return useContext(I18nContext);
}
